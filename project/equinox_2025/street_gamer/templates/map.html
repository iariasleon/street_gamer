<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <h1>STREET GAMER</h1>
    <div class="container">
        <div id="map-container">
                <form method="get">
                    <input type="text" name="ciudad" placeholder="Escribe una ciudad" value="{{ ciudad }}">                   
                </form>
            <div id="map">{{ map|safe }}</div>
            <button id="jugar-btn">JUGAR</button>
        </div>
        <div id="preguntas-container">
            <div id="preguntas">
                <h2>Preguntas:</h2>
                <form method="post" action="/submit-answers/">
                    {% csrf_token %}
                    {% for question in questions %}
                        <div>
                            <p>
                                <strong>{{ question.pregunta }}</strong>
                                <img src="/static/images/interrogacion.jpg" alt="?" style="width: 16px; height: 16px; vertical-align: middle;">
                            </p>
                            {% for opcion in question.opciones %}
                                <label>
                                    <input type="radio" name="question" value="{{ opcion }}">
                                    {{ opcion }}
                                </label><br>
                            {% endfor %}
                        </div>
                    {% endfor %}
                    <button type="submit">Comprobar</button>
                </form>
            </div>
        </div>
    </div>
    <script>
        window.onload = function() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
            function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;

                document.getElementById("ubicacion").innerText =
                `Lat: ${lat}, Lng: ${lng}`;

                console.log("Latitud:", lat, "Longitud:", lng);

                // üëá Enviar al backend Django con fetch
                fetch("http://127.0.0.1:8000/location/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCookie("csrftoken") // necesario si usas CSRF
                    },
                    body: JSON.stringify({
                        latitude: lat,
                        longitude: lng
                    })
                })
                .then(response => response.json())
                .then(data => {
                console.log("Respuesta Django:", data);
                })
                .catch(error => {
                console.error("Error en fetch:", error);
                });
            },
            function(error) {
                alert("Error al obtener la ubicaci√≥n: " + error.message);
            }
            );
        } else {
            alert("Geolocalizaci√≥n no soportada en este navegador.");
        }
        };

        function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
        }        
    </script>
</body>
</html>
