<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <h1>STREET GAMER</h1>
    <div class="container">
        <div id="map-container">
                <form method="get">
                    <input type="text" name="ciudad" placeholder="Escribe una ciudad" value="{{ ciudad }}">
                    <button type="submit">Buscar</button>
                </form>
            <div id="map">{{ map|safe }}</div>
            <button id="jugar-btn">JUGAR</button>
            <button id="sendLocation">Enviar mi ubicación</button>
            <div id="result" style="margin-top: 20px;"> </div>
        </div>
        <div id="preguntas-container">
            <div id="preguntas">
                <h2>Preguntas:</h2>
                <ul id="lista-preguntas"></ul>
            </div>
        </div>
    </div>
    <script>
        const token = "8390af118ee15edeeb60a854b20d9a1200df42ea"; // reemplaza con tu token
        const boton = document.getElementById('jugar-btn');
        const preguntasDiv = document.getElementById('preguntas');
        const listaPreguntas = document.getElementById('lista-preguntas');
        const preguntas = [
            "¿Cuál es el nombre del estadio principal de fútbol en Madrid?",
            "¿Qué famoso museo se encuentra en Madrid y forma parte del Triángulo del Arte?",
            "¿Cómo se llama la plaza central más conocida de Madrid?",
            "¿Qué río atraviesa la ciudad de Madrid?",
            "¿Cuál es el nombre del parque más grande de Madrid?"
        ];

        const opciones = [
            ["Santiago Bernabéu", "Wanda Metropolitano", "Vicente Calderón"],
            ["Museo del Prado", "Museo Reina Sofía", "Museo Thyssen-Bornemisza"],
            ["Puerta del Sol", "Plaza Mayor", "Plaza de España"],
            ["Río Manzanares", "Río Tajo", "Río Jarama"],
            ["Parque del Retiro", "Casa de Campo", "Parque Juan Carlos I"]
        ];

        const respuestasCorrectas = [
            "Santiago Bernabéu",
            "Museo del Prado",
            "Plaza Mayor",
            "Río Manzanares",
            "Parque del Retiro"
        ];

        document.getElementById("sendLocation").addEventListener("click", () => {
            if (!navigator.geolocation) {
                alert("Tu navegador no soporta geolocalización");
                return;
            }

            navigator.geolocation.getCurrentPosition(
                position => {
                    const data = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    };

                    fetch("http://127.0.0.1:8000/location/", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": "Token " + token
                        },
                        body: JSON.stringify(data)
                    })
                    .then(res => res.json())
                    .then(resp => {
                        let html = `<p><b>Ubicación enviada:</b> ${resp.latitude}, ${resp.longitude}</p>`;

                        if (resp.reached_places && resp.reached_places.length > 0) {
                            html += "<p><b>Lugares alcanzados:</b></p><ul>";
                            resp.reached_places.forEach(p => {
                                html += `<li>${p.place} - ${p.distance_m} metros - Pregunta: ${p.question}</li>`;
                            });
                            html += "</ul>";
                        } else {
                            html += "<p>No has llegado a ningún lugar aún</p>";
                        }

                        document.getElementById("result").innerHTML = html;
                    })
                    .catch(err => {
                        console.error(err);
                        alert("Error enviando ubicación");
                    });
                },
                error => {
                    console.error(error);
                    alert("No se pudo obtener la ubicación");
                },
                { enableHighAccuracy: true }
            );
        });
        boton.addEventListener('click', () => {
            preguntasDiv.style.display = 'block';
            listaPreguntas.innerHTML = ""; // Limpiar preguntas previas
            preguntas.forEach((pregunta, index) => {
                const li = document.createElement('li');
                const img = document.createElement('img');
                img.src = "/static/images/interrogacion.jpg";
                img.alt = "?";
                img.style.width = "16px";
                img.style.height = "16px";
                img.style.verticalAlign = "middle";

                li.innerHTML = `${pregunta} `;
                li.appendChild(img);

                const opcionesDiv = document.createElement('div');
                opciones[index].forEach((opcion) => {
                    const label = document.createElement('label');
                    label.style.display = 'block';
                    const checkbox = document.createElement('input');
                    checkbox.type = 'radio';
                    checkbox.name = `pregunta-${index}`;
                    checkbox.value = opcion;
                    label.appendChild(checkbox);
                    label.appendChild(document.createTextNode(opcion));
                    opcionesDiv.appendChild(label);
                });

                const comprobarBtn = document.createElement('button');
                comprobarBtn.textContent = "Comprobar";
                comprobarBtn.style.marginTop = "10px";
                comprobarBtn.addEventListener('click', () => {
                    const seleccionada = document.querySelector(`input[name="pregunta-${index}"]:checked`);
                    if (seleccionada) {
                        if (seleccionada.value === respuestasCorrectas[index]) {
                            img.src = "/static/images/ok.png";
                        } else {
                            img.src = "/static/images/ko.png";
                        }
                    } else {
                        alert("Por favor, selecciona una opción antes de comprobar.");
                    }
                });

                li.appendChild(opcionesDiv);
                li.appendChild(comprobarBtn);
                listaPreguntas.appendChild(li);
            });
        });
    </script>
</body>
</html>
